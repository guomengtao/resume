<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PeerJS Video Chat</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; margin-bottom: 10px; }
    #peer-id, #connect-to { width: 200px; }
  </style>
</head>
<body>
  <h2>PeerJS Video Chat</h2>
  <video id="local-video" autoplay playsinline muted style="width: 45%;"></video>
  <video id="remote-video" autoplay playsinline style="width: 45%;"></video>
  <p>Your Peer ID: <span id="my-id">...</span></p>

  <input type="text" id="connect-to" placeholder="Peer ID to connect" disabled>
  <button id="connect-btn">å¼€å§‹å¯»æ‰¾åœ¨çº¿çš„ç”¨æˆ·è¿›è¡Œè¿æ¥</button>

  <div id="log"></div>

  <script>
    // è‡ªåŠ¨åˆ†é… agent01~agent10 çš„ PeerJS ID
    const candidateIds = Array.from({length: 10}, (_, i) => `agent${String(i+1).padStart(2, '0')}`);
    let peer;
    let localStream;

    const logEl = document.getElementById('log');
    const connectToInput = document.getElementById('connect-to');
    const connectBtn = document.getElementById('connect-btn');
    const myIdEl = document.getElementById('my-id');

    function log(msg) {
      logEl.innerHTML += msg + '<br>';
      logEl.scrollTop = logEl.scrollHeight;
    }

    function tryNextId(index = 0) {
      if (index >= candidateIds.length) {
        log('âŒ æ‰€æœ‰ ID éƒ½è¢«å ç”¨äº†');
        return;
      }

      const tryId = candidateIds[index];
      const testPeer = new Peer(tryId);

      let handled = false; // é˜²æ­¢å¤šæ¬¡è°ƒç”¨

      testPeer.on('open', id => {
        if (handled) return;
        handled = true;

        log(`âœ… æˆåŠŸæ³¨å†Œ ID: ${id}`);
        myIdEl.textContent = id;
        peer = testPeer;
        setupPeerEvents();
        // æ³¨å†ŒæˆåŠŸï¼Œåœæ­¢åç»­å°è¯•
      });

      testPeer.on('error', err => {
        if (handled) return;
        handled = true;

        log(`â›”ï¸ ID ${tryId} è¢«å ç”¨ï¼Œæ— æ³•æ³¨å†Œ`);
        testPeer.destroy();  // å…³é—­æ­¤ Peer å®ä¾‹
        tryNextId(index + 1); // å°è¯•ä¸‹ä¸€ä¸ª ID
      });
    }

    function setupPeerEvents() {
      peer.on('connection', connection => {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
          localStream = stream;
          document.getElementById('local-video').srcObject = stream;
          const call = peer.call(connection.peer, stream);
          call.on('stream', remoteStream => {
            document.getElementById('remote-video').srcObject = remoteStream;
          });
        });
      });

      peer.on('call', call => {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
          localStream = stream;
          document.getElementById('local-video').srcObject = stream;
          call.answer(stream);
          call.on('stream', remoteStream => {
            document.getElementById('remote-video').srcObject = remoteStream;
          });
        });
      });

      connectBtn.onclick = async () => {
        const availableIds = candidateIds.filter(id => id !== peer.id);
        for (const peerId of availableIds) {
          try {
            const conn = await new Promise((resolve, reject) => {
              const tempConn = peer.connect(peerId);
              tempConn.on('open', () => resolve(tempConn));
              tempConn.on('error', () => reject());
              setTimeout(() => reject(), 1000); // Timeout
            });

            log(`ğŸ”— æˆåŠŸè¿æ¥åˆ° ${peerId}ï¼Œå¼€å§‹è§†é¢‘é€šè¯`);

            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
              localStream = stream;
              document.getElementById('local-video').srcObject = stream;
              const call = peer.call(peerId, stream);
              call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
              });
            });

            break; // Stop on successful connection
          } catch {
            log(`âŒ æ— æ³•è¿æ¥ ${peerId}ï¼Œå°è¯•ä¸‹ä¸€ä¸ª`);
          }
        }
      };
    }

    tryNextId(); // å¯åŠ¨è‡ªåŠ¨åˆ†é… ID
  </script>
</body>
</html>