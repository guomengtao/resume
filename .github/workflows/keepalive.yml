name: Supabase Keep Alive

on:
  workflow_dispatch:  # ğŸ‘ˆ æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  schedule:
    - cron: "*/10 * * * *"  # æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

jobs:
  ping-and-post:
    runs-on: ubuntu-latest

    steps:
      - name: Curl the website
        run: |
          echo "Pinging site..."
          curl -sSf https://666.rinuo.com || echo "Curl failed"

      - name: Maybe send daily message
        env:
          SUPABASE_URL: https://vbpbytebpaihpauwcryn.supabase.co
          SUPABASE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...ï¼ˆä½ è‡ªå·±çš„å®Œæ•´å¯†é’¥ï¼‰
        run: |
          echo "Checking if it's time to send daily message..."
          TZ=Asia/Shanghai
          DATE=$(date +"%Y-%m-%d")
          CURRENT_HOUR=$(date +"%H")
          SELECTED_HOUR=$(expr $(echo $((RANDOM % 14 + 8))))  # between 8~21

          echo "Target hour: $SELECTED_HOUR, Now: $CURRENT_HOUR"

          if [ "$CURRENT_HOUR" = "$SELECTED_HOUR" ]; then
            echo "Sending daily message..."
            curl -X POST "$SUPABASE_URL/rest/v1/messages" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"username\":\"bot\",\"content\":\"Today is $DATE\"}"
          else
            echo "Not the selected hour. Skipping send."
          fi