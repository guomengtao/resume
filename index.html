<h1>Chatroom Demo</h1>
<div id="chat" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
<input id="input" type="text" placeholder="Type a message..." style="width: 70%;" />
<button id="send">Send</button>
<hr>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const send = document.getElementById('send');

  const onlineUsersDiv = document.createElement('div');
  onlineUsersDiv.style.marginBottom = '10px';
  document.body.insertBefore(onlineUsersDiv, chat);

  const supabaseUrl = 'https://vbpbytebpaihpauwcryn.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZicGJ5dGVicGFpaHBhdXdjcnluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MjgzMzcsImV4cCI6MjA2NTAwNDMzN30.fW-XLBBgtUHtMWM_DYIowqz39SZpenkmgJfE_RZuc74';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  let username = 'User' + Math.floor(Math.random() * 1000);

  function updateOnlineUsers(presence) {
    const users = presence.state;
    const names = Object.values(users).map(u => u.metadata.username);
    onlineUsersDiv.textContent = `在线用户 (${names.length}): ${names.join(', ')}`;
  }

  const presenceChannel = supabase.channel('presence:messages', {
    config: {
      presence: {
        key: username
      }
    }
  })
    .on('presence', { event: 'sync' }, () => {
      updateOnlineUsers(presenceChannel.presence);
    })
    .subscribe();

  presenceChannel.track({ username });

  function appendMessage(text, time = '') {
    const p = document.createElement('p');
    p.textContent = time ? `[${time}] ${text}` : text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  async function loadMessages() {
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .order('inserted_at', { ascending: true })
      .limit(100);
    if (error) {
      console.error('Error loading messages:', error);
      return;
    }
    data.forEach(msg => {
      const time = new Date(msg.inserted_at).toLocaleTimeString();
      appendMessage(`${msg.username}: ${msg.content}`, time);
    });
  }

  loadMessages();

  supabase
    .channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
      const { username, content, inserted_at } = payload.new;
      const time = new Date(inserted_at).toLocaleTimeString();
      appendMessage(`${username}: ${content}`, time);
    })
    .subscribe();

  send.onclick = async () => {
    const message = input.value.trim();
    if (!message) return;
    await supabase.from('messages').insert([{ username, content: message }]);
    input.value = '';
  };

  input.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      send.click();
    }
  });
</script>