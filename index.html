<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatroom Demo </title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chat {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
      flex-grow: 1;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #online-users {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #nickname {
      width: 200px;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #888;
      border-radius: 4px;
      font-size: 14px;
    }
    #input {
      width: 70%;
      padding: 8px 10px;
      border: 1px solid #888;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 5px;
    }
    #send {
      padding: 8px 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #send:hover {
      background-color: #45a049;
    }
    #sidebar {
      width: 200px;
      border: 1px solid #ccc;
      padding: 10px;
      background: #f3f3f3;
      height: 300px;
      overflow-y: auto;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #user-list p {
      margin: 4px 0;
      font-size: 14px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="main">
    <h1>Chatroom Demo v1.6.4</h1>
    <div id="online-users">在线用户 (0):</div>
    <div id="chat"></div>
    <div>
      <input type="text" id="input" placeholder="输入消息" />
      <button id="send">发送</button>
    </div>
    <label for="nickname">昵称:</label><br/>
    <input type="text" id="nickname" placeholder="输入昵称" />
  </div>
  <div id="sidebar">
    <h2>用户列表</h2>
    <div id="user-list">加载中...</div>
  </div>

  <script>
    console.log("Script started");

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const nicknameInput = document.getElementById('nickname');
    const onlineUsersDiv = document.getElementById('online-users');
    const userListDiv = document.getElementById('user-list');

    async function init() {
      const supabaseUrl = 'https://vbpbytebpaihpauwcryn.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZicGJ5dGVicGFpaHBhdXdjcnluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MjgzMzcsImV4cCI6MjA2NTAwNDMzN30.fW-XLBBgtUHtMWM_DYIowqz39SZpenkmgJfE_RZuc74';

      console.log("Creating Supabase client...");
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

      const randomNicknames = [
        'Eagle', 'Tiger', 'Lion', 'Falcon', 'Wolf',
        'Hawk', 'Panther', 'Bear', 'Fox', 'Dragon',
        'Shark', 'Phoenix', 'Leopard', 'Cheetah', 'Jaguar'
      ];

      // Use localStorage to persist nickname on refresh
      let storedName = localStorage.getItem('chat_nickname');
      let username = storedName && storedName.trim().length > 0 ? storedName : randomNicknames[Math.floor(Math.random() * randomNicknames.length)] + Math.floor(Math.random() * 1000);
      nicknameInput.value = username;
      console.log("Generated username:", username);

      let presenceChannel;

      function updateOnlineUsers(presence) {
        console.log("updateOnlineUsers called with presence:", presence);

        if (!presence || !presence.state || Object.keys(presence.state).length === 0) {
          console.log("Presence or presence.state is empty or undefined");
          onlineUsersDiv.textContent = `在线用户 (1): ${username}`;
          userListDiv.innerHTML = "";
          const p = document.createElement("p");
          p.textContent = username;
          userListDiv.appendChild(p);
          return;
        }

        const users = presence.state;
        console.log("Current presence.state users:", users);

        Object.entries(users).forEach(([key, userArray]) => {
          console.log(`User key: ${key}`, userArray);
        });

        // Collect unique usernames from all metas
        const uniqueUsernames = new Set();
        const userEntries = Object.entries(users).filter(([key, userArray]) => {
          if (!Array.isArray(userArray)) {
            console.warn(`Skipping invalid user entry:`, key, userArray);
            return false;
          }
          const isValid = userArray.some(meta => meta && typeof meta.username === 'string');
          console.log(`User ${key} isValid: ${isValid}, metas:`, userArray);
          return isValid;
        });

        console.log("Filtered user entries with metas:", userEntries);

        userEntries.forEach(([key, userArray]) => {
          userArray.forEach(meta => {
            console.log("Processing meta:", meta);
            if (meta && typeof meta.username === 'string') {
              uniqueUsernames.add(meta.username);
            }
          });
        });

        const userCount = uniqueUsernames.size;

        onlineUsersDiv.textContent = `在线用户 (${userCount}): ${[...uniqueUsernames].join(', ')}`;

        userListDiv.innerHTML = "";
        uniqueUsernames.forEach(name => {
          const p = document.createElement("p");
          p.textContent = name;
          userListDiv.appendChild(p);
        });
      }

      // Generate a unique key for this user/session for presence tracking
      function generatePresenceKey() {
        // Use a random string plus timestamp for uniqueness
        return `${username}_${Math.random().toString(36).slice(2, 10)}_${Date.now()}`;
      }
      let presenceKey = generatePresenceKey();

      nicknameInput.addEventListener('input', () => {
        const newName = nicknameInput.value.trim();
        if (newName.length > 0 && newName !== username) {
          username = newName;
          localStorage.setItem('chat_nickname', username);
          // Regenerate presence key and re-track to update presence reliably
          presenceKey = generatePresenceKey();
          if (presenceChannel) {
            presenceChannel.untrack().catch(console.error);
            presenceChannel.track({ username, joined_at: Date.now() }, { key: presenceKey }).catch(console.error);
            console.log("Username changed to:", username);
          }
        }
      });

      // Subscribe to presence channel with unique key
      presenceChannel = supabaseClient.channel('presence:messages', {
        config: { presence: { key: presenceKey } }
      });

      presenceChannel.on('presence', { event: 'sync' }, () => {
        console.log("Presence sync event triggered");
        setTimeout(() => {
          updateOnlineUsers(presenceChannel.presence);
        }, 100);
      });

      await presenceChannel.subscribe();

      await presenceChannel.track({ username, joined_at: Date.now() }, { key: presenceKey });
      console.log("Presence tracking started for username:", username, "with key:", presenceKey);

      function appendMessage(text, time = '') {
        const p = document.createElement('p');
        if (time) {
          p.innerHTML = `<strong>[${time}]</strong> <span style="color:#3366cc;font-weight:bold;">${text}</span>`;
        } else {
          p.innerHTML = `<span style="color:#3366cc;font-weight:bold;">${text}</span>`;
        }
        chat.appendChild(p);
        chat.scrollTop = chat.scrollHeight;
      }

      async function loadMessages() {
        console.log("Loading existing messages...");
        const { data, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('inserted_at', { ascending: true })
          .limit(100);
        if (error) {
          console.error('Error loading messages:', error);
          return;
        }
        console.log("Loaded messages:", data.length);
        data.forEach(msg => {
          const time = new Date(msg.inserted_at).toLocaleTimeString();
          appendMessage(`${msg.username}: ${msg.content}`, time);
        });
      }

      await loadMessages();

      const messagesChannel = supabaseClient.channel('public:messages');

      messagesChannel
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'messages'
          },
          payload => {
            const { username, content, inserted_at } = payload.new;
            const time = new Date(inserted_at).toLocaleTimeString();
            console.log("Realtime message received:", username, content, inserted_at);
            appendMessage(`<span style="color:#3366cc;">${username || "Unknown"}</span>: ${content || "(No content)"}`, time);
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('Successfully subscribed to message channel');
          } else {
            console.warn('Subscription status changed:', status);
          }
        });

      send.onclick = async () => {
        const message = input.value.trim();
        if (!message) {
          console.log("Empty message, ignoring send");
          return;
        }
        console.log("Sending message:", message);
        const { error } = await supabaseClient.from('messages').insert([{ username, content: message }]);
        if (error) {
          console.error("Error sending message:", error);
        } else {
          console.log("Message sent successfully, waiting for realtime update...");
          input.value = '';
        }
      };

      input.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          send.click();
        }
      });

      console.log("Script finished setup");
    }

    init();
  </script>
</body>
</html>