<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatroom Demo v1.6.1</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chat {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
      flex-grow: 1;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #online-users {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #nickname {
      width: 200px;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #888;
      border-radius: 4px;
      font-size: 14px;
    }
    #input {
      width: 70%;
      padding: 8px 10px;
      border: 1px solid #888;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 5px;
    }
    #send {
      padding: 8px 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #send:hover {
      background-color: #45a049;
    }
    #sidebar {
      width: 200px;
      border: 1px solid #ccc;
      padding: 10px;
      background: #f3f3f3;
      height: 300px;
      overflow-y: auto;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #user-list p {
      margin: 4px 0;
      font-size: 14px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="main">
    <h1>Chatroom Demo v1.6.1</h1>
    <div id="online-users">在线用户 (0):</div>
    <div id="chat"></div>
    <div>
      <input type="text" id="input" placeholder="输入消息" />
      <button id="send">发送</button>
    </div>
    <label for="nickname">昵称:</label><br/>
    <input type="text" id="nickname" placeholder="输入昵称" />
  </div>
  <div id="sidebar">
    <h2>用户列表</h2>
    <div id="user-list">加载中...</div>
  </div>

  <script>
    console.log("Script started");

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const nicknameInput = document.getElementById('nickname');
    const onlineUsersDiv = document.getElementById('online-users');
    const userListDiv = document.getElementById('user-list');

    async function init() {
      const supabaseUrl = 'https://vbpbytebpaihpauwcryn.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZicGJ5dGVicGFpaHBhdXdjcnluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MjgzMzcsImV4cCI6MjA2NTAwNDMzN30.fW-XLBBgtUHtMWM_DYIowqz39SZpenkmgJfE_RZuc74';

      console.log("Creating Supabase client...");
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

      const randomNicknames = [
        'Eagle', 'Tiger', 'Lion', 'Falcon', 'Wolf',
        'Hawk', 'Panther', 'Bear', 'Fox', 'Dragon',
        'Shark', 'Phoenix', 'Leopard', 'Cheetah', 'Jaguar'
      ];

      let username = randomNicknames[Math.floor(Math.random() * randomNicknames.length)] + Math.floor(Math.random() * 1000);
      nicknameInput.value = username;
      console.log("Generated username:", username);

      let presenceChannel;

      function updateOnlineUsers(presence) {
        console.log("Updating online users presence:", presence);
        const users = presence.state;

        // Filter valid users with metadata and username
        const userEntries = Object.entries(users).filter(([key, user]) => user.metadata && user.metadata.username);
        const names = userEntries.map(([key, user]) => user.metadata.username);

        // Show at least 1 user if no others online (self)
        const displayCount = names.length > 0 ? names.length : 1;
        onlineUsersDiv.textContent = `在线用户 (${displayCount}): ${names.length > 0 ? names.join(', ') : username}`;

        if (userEntries.length === 0) {
          userListDiv.textContent = '无在线用户';
          // But still show current user
          const p = document.createElement('p');
          p.textContent = `${username} (加入时间: 现在)`;
          userListDiv.appendChild(p);
          return;
        }

        userListDiv.innerHTML = '';
        userEntries.forEach(([key, user]) => {
          const p = document.createElement('p');
          p.textContent = `${user.metadata.username} (加入时间: ${new Date(user.joined_at).toLocaleTimeString()})`;
          userListDiv.appendChild(p);
        });
      }

      nicknameInput.addEventListener('input', () => {
        const newName = nicknameInput.value.trim();
        if (newName.length > 0) {
          username = newName;
          if (presenceChannel) {
            presenceChannel.track({ username }).catch(console.error);
            console.log("Username changed to:", username);
          }
        }
      });

      presenceChannel = await supabaseClient.channel('presence:messages', {
        config: { presence: { key: username } }
      });

      presenceChannel.on('presence', { event: 'sync' }, () => {
        console.log("Presence sync event triggered");
        updateOnlineUsers(presenceChannel.presence);
      });

      await presenceChannel.subscribe();

      presenceChannel.track({ username }).catch(console.error);
      console.log("Presence tracking started for username:", username);

      function appendMessage(text, time = '') {
        const p = document.createElement('p');
        p.innerHTML = time ? `<strong>[${time}]</strong> ${text}` : text;
        chat.appendChild(p);
        chat.scrollTop = chat.scrollHeight;
      }

      async function loadMessages() {
        console.log("Loading existing messages...");
        const { data, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('inserted_at', { ascending: true })
          .limit(100);
        if (error) {
          console.error('Error loading messages:', error);
          return;
        }
        console.log("Loaded messages:", data.length);
        data.forEach(msg => {
          const time = new Date(msg.inserted_at).toLocaleTimeString();
          appendMessage(`${msg.username}: ${msg.content}`, time);
        });
      }

      loadMessages();

      const messagesChannel = supabaseClient.channel('realtime:public:messages');

      messagesChannel
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'messages'
          },
          payload => {
            console.log("New message received:", payload.new);
            const { username: sender, content, inserted_at } = payload.new;
            const time = new Date(inserted_at).toLocaleTimeString();
            appendMessage(`<strong>${sender}</strong>: ${content}`, time);
          }
        )
        .subscribe((status) => {
          console.log('Message channel subscription status:', status);
        });

      send.onclick = async () => {
        const message = input.value.trim();
        if (!message) {
          console.log("Empty message, ignoring send");
          return;
        }
        console.log("Sending message:", message);
        const { error } = await supabaseClient.from('messages').insert([{ username, content: message }]);
        if (error) {
          console.error("Error sending message:", error);
        } else {
          console.log("Message sent successfully");
          // We no longer append immediately; we wait for the server push
          input.value = '';
        }
      };

      input.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          send.click();
        }
      });

      console.log("Script finished setup");
    }

    init();
  </script>
</body>
</html>