<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatroom Demo </title>
  <style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    display: flex;
    flex-direction: row;
    gap: 20px;
    background-color: #fafafa;
    color: #333;
  }
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 700px;
  }
  #input-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }
  #nickname-label {
    font-weight: 600;
    font-size: 15px;
    white-space: nowrap;
  }
  #nickname {
    width: 140px;
    padding: 9px 12px;
    border: 1px solid #bbb;
    border-radius: 6px;
    font-size: 15px;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
    height: 36px;
    box-sizing: border-box;
  }
  #nickname:focus {
    border-color: #4caf50;
    box-shadow: 0 0 6px #a4d4a4;
  }
  #input {
    flex-grow: 1;
    padding: 10px 14px;
    border: 1px solid #bbb;
    border-radius: 6px;
    font-size: 15px;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
    height: 36px;
    box-sizing: border-box;
  }
  #input:focus {
    border-color: #4caf50;
    box-shadow: 0 0 6px #a4d4a4;
  }
  #send {
    padding: 10px 18px;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.25s ease;
    height: 36px;
    width: 90px;
    flex-shrink: 0;
  }
  #send:hover,
  #send:focus {
    background-color: #43a047;
    outline: none;
  }
  #chat {
    border: 1px solid #ddd;
    height: 320px;
    overflow-y: auto;
    padding: 12px 15px;
    margin-bottom: 12px;
    background-color: #fff;
    flex-grow: 1;
    white-space: pre-wrap;
    word-wrap: break-word;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
  }
  #online-users {
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 16px;
    color: #555;
  }
  #sidebar {
    width: 220px;
    border: 1px solid #ddd;
    padding: 12px 15px;
    background: #fefefe;
    height: 320px;
    overflow-y: auto;
    border-radius: 6px;
    box-shadow: 0 1px 6px rgb(0 0 0 / 0.08);
  }
  #sidebar h2 {
    margin-top: 0;
    font-size: 20px;
    margin-bottom: 14px;
    color: #444;
  }
  #user-list p {
    margin: 6px 0;
    font-size: 14.5px;
    color: #333;
    padding-left: 6px;
    border-left: 3px solid #4caf50;
    border-radius: 2px;
  }
  /* Scrollbar styling */
  #chat::-webkit-scrollbar,
  #sidebar::-webkit-scrollbar {
    width: 8px;
  }
  #chat::-webkit-scrollbar-thumb,
  #sidebar::-webkit-scrollbar-thumb {
    background-color: #bbb;
    border-radius: 4px;
  }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="main">
    <h1>Chatroom Demo v1.6.4</h1>
    <div id="online-users">在线用户 (0):</div>
    <div id="chat"></div>
    <div id="input-row">
      <label for="nickname" id="nickname-label">昵称:</label>
      <input type="text" id="nickname" placeholder="输入昵称" />
      <input type="text" id="input" placeholder="输入消息" />
      <button id="send">发送</button>
    </div>
  </div>
  <div id="sidebar">
    <h2>用户列表</h2>
    <div id="user-list">加载中...</div>
  </div>

  <script>
    console.log("Script started");

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const nicknameInput = document.getElementById('nickname');
    const onlineUsersDiv = document.getElementById('online-users');
    const userListDiv = document.getElementById('user-list');

    async function init() {
      const supabaseUrl = 'https://vbpbytebpaihpauwcryn.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZicGJ5dGVicGFpaHBhdXdjcnluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MjgzMzcsImV4cCI6MjA2NTAwNDMzN30.fW-XLBBgtUHtMWM_DYIowqz39SZpenkmgJfE_RZuc74';

      console.log("Creating Supabase client...");
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

      const randomNicknames = [
        'Eagle', 'Tiger', 'Lion', 'Falcon', 'Wolf',
        'Hawk', 'Panther', 'Bear', 'Fox', 'Dragon',
        'Shark', 'Phoenix', 'Leopard', 'Cheetah', 'Jaguar'
      ];

      // Use localStorage to persist nickname on refresh
      let storedName = localStorage.getItem('chat_nickname');
      let username = storedName && storedName.trim().length > 0 ? storedName : randomNicknames[Math.floor(Math.random() * randomNicknames.length)] + Math.floor(Math.random() * 1000);
      nicknameInput.value = username;
      console.log("Generated username:", username);

      let presenceChannel;

      function updateOnlineUsers(presence) {
        console.log("updateOnlineUsers called with presence:", presence);

        if (!presence || !presence.state || Object.keys(presence.state).length === 0) {
          console.log("Presence or presence.state is empty or undefined");
          onlineUsersDiv.textContent = `在线用户 (1): ${username}`;
          userListDiv.innerHTML = "";
          const p = document.createElement("p");
          p.textContent = username;
          userListDiv.appendChild(p);
          return;
        }

        const users = presence.state;
        console.log("Current presence.state users:", users);

        Object.entries(users).forEach(([key, userArray]) => {
          console.log(`User key: ${key}`, userArray);
        });

        // Collect unique usernames from all metas
        const uniqueUsernames = new Set();
        const userEntries = Object.entries(users).filter(([key, userArray]) => {
          if (!Array.isArray(userArray)) {
            console.warn(`Skipping invalid user entry:`, key, userArray);
            return false;
          }
          const isValid = userArray.some(meta => meta && typeof meta.username === 'string');
          console.log(`User ${key} isValid: ${isValid}, metas:`, userArray);
          return isValid;
        });

        console.log("Filtered user entries with metas:", userEntries);

        userEntries.forEach(([key, userArray]) => {
          userArray.forEach(meta => {
            console.log("Processing meta:", meta);
            if (meta && typeof meta.username === 'string') {
              uniqueUsernames.add(meta.username);
            }
          });
        });

        const userCount = uniqueUsernames.size;

        onlineUsersDiv.textContent = `在线用户 (${userCount}): ${[...uniqueUsernames].join(', ')}`;

        userListDiv.innerHTML = "";
        uniqueUsernames.forEach(name => {
          const p = document.createElement("p");
          p.textContent = name;
          userListDiv.appendChild(p);
        });
      }

      // Generate a unique key for this user/session for presence tracking
      function generatePresenceKey() {
        // Use a random string plus timestamp for uniqueness
        return `${username}_${Math.random().toString(36).slice(2, 10)}_${Date.now()}`;
      }
      let presenceKey = generatePresenceKey();

      nicknameInput.addEventListener('input', () => {
        const newName = nicknameInput.value.trim();
        if (newName.length > 0 && newName !== username) {
          username = newName;
          localStorage.setItem('chat_nickname', username);
          // Regenerate presence key and re-track to update presence reliably
          presenceKey = generatePresenceKey();
          if (presenceChannel) {
            presenceChannel.untrack().catch(console.error);
            presenceChannel.track({ username, joined_at: Date.now() }, { key: presenceKey }).catch(console.error);
            console.log("Username changed to:", username);
          }
        }
      });

      // Subscribe to presence channel with unique key
      presenceChannel = supabaseClient.channel('presence:messages', {
        config: { presence: { key: presenceKey } }
      });

      presenceChannel.on('presence', { event: 'sync' }, () => {
        console.log("Presence sync event triggered");
        setTimeout(() => {
          updateOnlineUsers(presenceChannel.presence);
        }, 100);
      });

      await presenceChannel.subscribe();

      await presenceChannel.track({ username, joined_at: Date.now() }, { key: presenceKey });
      console.log("Presence tracking started for username:", username, "with key:", presenceKey);

      // 友好时间格式函数
      function formatTime(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        if (diffSec < 60) return '刚刚';
        const diffMin = Math.floor(diffSec / 60);
        if (diffMin < 60) return `${diffMin}分钟前`;
        const diffHour = Math.floor(diffMin / 60);
        if (diffHour < 24) return `${diffHour}小时前`;
        return date.toLocaleDateString();
      }

      // 哈希字符串生成颜色函数
      function getUsernameColor(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colors = [
          '#e21400', '#91580f', '#f8a700', '#f78b00',
          '#58dc00', '#287b00', '#a8f07a', '#4ae8c4',
          '#3b88eb', '#3824aa', '#a700ff', '#d300e7'
        ];
        return colors[Math.abs(hash) % colors.length];
      }

      // 显示消息时调用 formatTime 和 getUsernameColor
      function appendMessage(text, time = '', username = '') {
        const p = document.createElement('p');
        const timeStr = time ? `<strong>[${formatTime(new Date(time))}]</strong> ` : '';
        const color = username ? getUsernameColor(username) : '#3366cc';
        p.innerHTML = `${timeStr}<span style="color:${color}; font-weight:bold;">${text}</span>`;
        chat.appendChild(p);
        chat.scrollTop = chat.scrollHeight;
      }

      async function loadMessages() {
        console.log("Loading existing messages...");
        const { data, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('inserted_at', { ascending: true })
          .limit(100);
        if (error) {
          console.error('Error loading messages:', error);
          return;
        }
        console.log("Loaded messages:", data.length);
        data.forEach(msg => {
          appendMessage(`${msg.username}: ${msg.content}`, msg.inserted_at, msg.username);
        });
      }

      await loadMessages();

      const messagesChannel = supabaseClient.channel('public:messages');

      messagesChannel
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'messages'
          },
          payload => {
            const { username, content, inserted_at } = payload.new;
            console.log("Realtime message received:", username, content, inserted_at);
            appendMessage(`${username || "Unknown"}: ${content || "(无内容)"}`, inserted_at, username);
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('Successfully subscribed to message channel');
          } else {
            console.warn('Subscription status changed:', status);
          }
        });

      send.onclick = async () => {
        const message = input.value.trim();
        if (!message) {
          console.log("Empty message, ignoring send");
          return;
        }
        console.log("Sending message:", message);
        const { error } = await supabaseClient.from('messages').insert([{ username, content: message }]);
        if (error) {
          console.error("Error sending message:", error);
        } else {
          console.log("Message sent successfully, waiting for realtime update...");
          input.value = '';
          // 发送后按钮禁用
          send.disabled = true;
        }
      };

      input.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          send.click();
        }
      });

      // 监听输入，控制发送按钮禁用
      input.addEventListener('input', () => {
        send.disabled = input.value.trim().length === 0;
      });

      // 初始化禁用发送按钮
      send.disabled = true;

      console.log("Script finished setup");
    }

    init();
  </script>
</body>
</html>