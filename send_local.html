<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC Signal Debugger</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 150px; }
    pre { background: #eee; padding: 10px; }
  </style>
</head>
<body>
  <h2>WebRTC æ‰‹åŠ¨ä¿¡ä»¤è°ƒè¯•å™¨</h2>
  <label>
    <input type="radio" name="role" value="initiator" checked /> å‘èµ·äºº
  </label>
  <label>
    <input type="radio" name="role" value="responder" /> åº”ç­”äºº
  </label>

  <div style="margin-top:10px;">
    <button id="startBtn">å¼€å§‹åˆ›å»º Peer</button>
  </div>

  <h3>æœ¬åœ°ç”Ÿæˆä¿¡ä»¤ (éœ€è¦å‘ç»™å¯¹æ–¹)</h3>
  <textarea id="localSignal" readonly></textarea>

  <!-- å·²ç§»é™¤æ‰‹åŠ¨è¾“å…¥ä¿¡ä»¤éƒ¨åˆ†ï¼Œæ”¹ä¸º localStorage è‡ªåŠ¨åŒæ­¥ -->

  <h3>æ§åˆ¶å°æ—¥å¿—</h3>
  <pre id="log"></pre>

  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
  <script>
    // ä¿¡ä»¤é€šé“ key
    const SIGNAL_KEY = 'webrtc-debugger-signal';
    let peer = null;

    function log(message) {
      console.log(message);
      const logElem = document.getElementById('log');
      logElem.textContent += message + '\n';
    }

    document.getElementById('startBtn').onclick = async () => {
      const role = document.querySelector('input[name="role"]:checked').value;
      log("ğŸ¯ è§’è‰²é€‰æ‹©: " + role);

      peer = new SimplePeer({ initiator: role === 'initiator', trickle: false });

      peer.on('signal', data => {
        const encoded = JSON.stringify(data);
        log("ğŸ“¡ æœ¬åœ°ç”Ÿæˆä¿¡ä»¤å¹¶å†™å…¥ localStorage:");
        log(encoded);
        document.getElementById('localSignal').value = encoded;
        localStorage.setItem(SIGNAL_KEY, encoded);
      });

      peer.on('connect', () => {
        log("âœ… Peer è¿æ¥æˆåŠŸï¼");
      });

      peer.on('error', err => {
        log("âŒ é”™è¯¯: " + err.message);
      });

      peer.on('data', data => {
        log("ğŸ“¥ æ”¶åˆ°æ•°æ®: " + data);
      });

      // å¦‚æœæ˜¯ responderï¼Œç«‹å³è¯»å– localStorage çœ‹æ˜¯å¦å·²æœ‰ offer
      if (role === 'responder') {
        const incoming = localStorage.getItem(SIGNAL_KEY);
        if (incoming) {
          try {
            const parsed = JSON.parse(incoming);
            log("ğŸ“¥ æ£€æµ‹åˆ°æœ¬åœ°å·²å­˜åœ¨å¯¹æ–¹ offerï¼Œç«‹å³ signal:");
            log(JSON.stringify(parsed, null, 2));
            peer.signal(parsed);
          } catch (e) {
            log("âŒ JSON è§£æé”™è¯¯");
          }
        }
      }
    };

    // ç›‘å¬ storage äº‹ä»¶ï¼Œè‡ªåŠ¨å“åº”å¦ä¸€ä¸ªé¡µé¢çš„ offer/answer
    window.addEventListener('storage', e => {
      if (e.key === SIGNAL_KEY && peer && !peer.destroyed) {
        try {
          const newSignal = JSON.parse(e.newValue);
          log("ğŸ“¥ æ£€æµ‹åˆ°å¦ä¸€çª—å£å†™å…¥ä¿¡ä»¤ï¼Œå°è¯• signal():");
          log(JSON.stringify(newSignal, null, 2));
          peer.signal(newSignal);
        } catch (e) {
          log("âŒ ç›‘å¬ storage æ—¶è§£æå¤±è´¥");
        }
      }
    });
  </script>
</body>
</html>