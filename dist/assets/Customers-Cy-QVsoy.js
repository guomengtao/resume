import{a as g}from"./apiClient-cE9tAAaD.js";import{_ as V,f as F,w as l,r as s,o as P,a as t,b as _,t as z,d as p}from"./index-DzemYwN4.js";import"./supabaseClient-Dqa0j5et.js";const S={name:"Customers",data(){return{customers:[],total:0,currentPage:1,pageSize:20,sortProp:"full_name",sortOrder:"ascending",followUpDialogVisible:!1,followUpForm:{contact_result:"",next_follow_up_date:""},followUpCustomer:null}},computed:{sortedCustomers(){if(!Array.isArray(this.customers)||!this.sortProp)return this.customers||[];const o=this.sortOrder==="ascending"?1:-1;return[...this.customers].sort((e,c)=>{const d=e[this.sortProp],r=c[this.sortProp];return d===r?0:d>r?o:-o})},pagedCustomers(){const o=(this.currentPage-1)*this.pageSize,e=o+this.pageSize;return this.sortedCustomers.slice(o,e)}},mounted(){this.loadCustomers()},methods:{async loadCustomers(){try{const o=await g("/view_customers_with_latest_followup","GET");console.log("API /view_customers_with_latest_followup response:",o),this.customers=Array.isArray(o.items)?o.items:[],this.total=o.total||0}catch(o){console.error("获取客户列表失败:",o),this.customers=[],this.total=0}},viewCustomer(o){console.log("查看",o)},editCustomer(o){console.log("编辑",o)},deleteCustomer(o){console.log("删除",o)},openFollowUpDialog(o){this.followUpCustomer=o,this.followUpForm={contact_result:"",next_follow_up_date:""},this.followUpDialogVisible=!0},async submitFollowUp(){try{await g("/followups","POST",{customer_id:this.followUpCustomer.uuid,contact_result:this.followUpForm.contact_result,next_follow_up_date:this.followUpForm.next_follow_up_date}),this.followUpDialogVisible=!1,this.loadCustomers()}catch(o){console.error("提交跟进失败:",o)}},handlePageChange(o){this.currentPage=o,this.loadCustomers()},goToAddCustomer(){this.$router.push("/customers/add")},handleSortChange({prop:o,order:e}){this.sortProp=o,this.sortOrder=e,this.loadCustomers()}}},D={style:{display:"flex","justify-content":"space-between","align-items":"center","font-weight":"600","font-size":"20px",color:"#303133"}};function A(o,e,c,d,r,i){const u=s("el-button"),a=s("el-table-column"),w=s("el-table"),h=s("el-pagination"),C=s("el-card"),b=s("el-input"),f=s("el-form-item"),y=s("el-date-picker"),x=s("el-form"),U=s("el-dialog"),k=s("el-main"),v=s("el-container");return P(),F(v,{style:{padding:"24px",background:"#fafafa","min-height":"100vh"}},{default:l(()=>[t(k,null,{default:l(()=>[t(C,{shadow:"hover",style:{"border-radius":"10px","box-shadow":"0 2px 12px rgba(0,0,0,0.05)",background:"#fff"}},{header:l(()=>[_("div",D,[e[5]||(e[5]=_("span",null,"客户列表",-1)),t(u,{type:"primary",icon:"el-icon-plus",size:"default",style:{"border-radius":"6px"},onClick:i.goToAddCustomer},{default:l(()=>e[4]||(e[4]=[p(" 添加客户 ")])),_:1,__:[4]},8,["onClick"])])]),default:l(()=>[t(w,{data:i.pagedCustomers,stripe:"",border:"","highlight-current-row":"",style:{width:"100%","border-radius":"6px",overflow:"hidden"},"default-sort":{prop:"full_name",order:"ascending"},onSortChange:i.handleSortChange},{default:l(()=>[t(a,{type:"index",label:"序号",width:"60",align:"center"}),t(a,{prop:"full_name",label:"姓名",sortable:"","min-width":"140",align:"center"}),t(a,{prop:"phone",label:"电话",sortable:"","min-width":"160",align:"center"}),t(a,{prop:"email",label:"邮箱","min-width":"180",align:"center"}),t(a,{prop:"company_name",label:"公司","min-width":"180",align:"center"}),t(a,{prop:"province",label:"省份","min-width":"100",align:"center"}),t(a,{prop:"city",label:"城市","min-width":"100",align:"center"}),t(a,{prop:"status",label:"状态","min-width":"100",align:"center"}),t(a,{prop:"last_followup",label:"最后跟进","min-width":"160",align:"center"},{default:l(n=>[_("span",null,z(n.row.last_followup?n.row.last_followup.slice(0,10):"暂无"),1)]),_:1}),t(a,{label:"操作",width:"300",align:"center"},{default:l(n=>[t(u,{type:"primary",icon:"el-icon-view",size:"small",onClick:m=>i.viewCustomer(n.row)},{default:l(()=>e[6]||(e[6]=[p("查看")])),_:2,__:[6]},1032,["onClick"]),t(u,{type:"warning",icon:"el-icon-edit",size:"small",onClick:m=>i.editCustomer(n.row)},{default:l(()=>e[7]||(e[7]=[p("编辑")])),_:2,__:[7]},1032,["onClick"]),t(u,{type:"danger",icon:"el-icon-delete",size:"small",onClick:m=>i.deleteCustomer(n.row.id)},{default:l(()=>e[8]||(e[8]=[p("删除")])),_:2,__:[8]},1032,["onClick"]),t(u,{type:"success",icon:"el-icon-message",size:"small",onClick:m=>i.openFollowUpDialog(n.row)},{default:l(()=>e[9]||(e[9]=[p("跟进")])),_:2,__:[9]},1032,["onClick"])]),_:1})]),_:1},8,["data","onSortChange"]),t(h,{background:"",layout:"total, prev, pager, next, jumper",total:r.total,"page-size":r.pageSize,"current-page":r.currentPage,style:{"margin-top":"30px","text-align":"right"},onCurrentChange:i.handlePageChange},null,8,["total","page-size","current-page","onCurrentChange"])]),_:1}),t(U,{modelValue:r.followUpDialogVisible,"onUpdate:modelValue":e[3]||(e[3]=n=>r.followUpDialogVisible=n),title:"登记跟进",width:"500px"},{footer:l(()=>[t(u,{onClick:e[2]||(e[2]=n=>r.followUpDialogVisible=!1)},{default:l(()=>e[10]||(e[10]=[p("取消")])),_:1,__:[10]}),t(u,{type:"primary",onClick:i.submitFollowUp},{default:l(()=>e[11]||(e[11]=[p("提交")])),_:1,__:[11]},8,["onClick"])]),default:l(()=>[t(x,{model:r.followUpForm,"label-width":"100px"},{default:l(()=>[t(f,{label:"跟进内容"},{default:l(()=>[t(b,{type:"textarea",modelValue:r.followUpForm.contact_result,"onUpdate:modelValue":e[0]||(e[0]=n=>r.followUpForm.contact_result=n)},null,8,["modelValue"])]),_:1}),t(f,{label:"下次时间"},{default:l(()=>[t(y,{modelValue:r.followUpForm.next_follow_up_date,"onUpdate:modelValue":e[1]||(e[1]=n=>r.followUpForm.next_follow_up_date=n),type:"date"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1})}const N=V(S,[["render",A],["__scopeId","data-v-9cf3ca8c"]]);export{N as default};
