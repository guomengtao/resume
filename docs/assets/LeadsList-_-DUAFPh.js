import{a as F}from"./apiClient-cE9tAAaD.js";import{_ as z,c as D,b as L,a as t,w as n,r as s,h as i,i as S,o as c,d as u,f as y,j as h}from"./index-DzemYwN4.js";import"./supabaseClient-Dqa0j5et.js";const P={name:"LeadsList",setup(){const v=i([]),e=i(""),C=i(1),l=i(10),b=i(0),w=i(""),r=i(""),_=i(!1),d=i({customer_id:null,contact_result:"",next_follow_up_date:"",notes:""}),m=async()=>{try{let a=`?page=${C.value}&pageSize=${l.value}`;w.value&&(a+=`&sortField=${w.value}&sortOrder=${r.value}`),e.value&&(a+=`&phoneLike=${e.value}`);const p=await F("/view_leads_with_latest_followup"+a,"GET");v.value=p.items||p,b.value=p.total||p.length}catch(a){console.error("加载线索失败:",a)}},k=a=>{C.value=a,m()},g=({prop:a,order:p})=>{w.value=a,r.value=p==="ascending"?"asc":"desc",m()},U=a=>{alert("查看: "+a.full_name)},V=a=>{alert("编辑: "+a.full_name)},x=async a=>{try{await F(`/leads/${a.id}`,"PATCH",{is_deleted:!0}),m()}catch(p){console.error("删除失败:",p)}},o=a=>{d.value={customer_id:a.uuid,contact_result:"",next_follow_up_date:"",notes:""},_.value=!0},f=async()=>{try{if(!d.value.customer_id)return;await F("/followups","POST",d.value),_.value=!1,m()}catch(a){console.error("提交跟进失败:",a)}};return S(()=>{m()}),{leads:v,searchPhone:e,page:C,pageSize:l,total:b,sortField:w,sortOrder:r,showFollowUpDialog:_,followUpForm:d,loadLeads:m,handlePageChange:k,handleSortChange:g,viewDetail:U,editLead:V,deleteLead:x,openFollowUpDialog:o,submitFollowUp:f,goToAddLead(){window.location.href="/leads/add"}}}},T={style:{"margin-bottom":"16px",display:"flex","align-items":"center"}},M={slot:"footer",class:"dialog-footer"};function B(v,e,C,l,b,w){const r=s("el-button"),_=s("el-input"),d=s("el-table-column"),m=s("el-table"),k=s("el-pagination"),g=s("el-form-item"),U=s("el-date-picker"),V=s("el-form"),x=s("el-dialog");return c(),D("div",null,[e[15]||(e[15]=L("h2",null,"线索列表",-1)),L("div",T,[t(r,{type:"primary",icon:"el-icon-plus",style:{"margin-right":"16px"},onClick:l.goToAddLead},{default:n(()=>e[6]||(e[6]=[u(" 添加线索 ")])),_:1,__:[6]},8,["onClick"]),t(_,{modelValue:l.searchPhone,"onUpdate:modelValue":e[0]||(e[0]=o=>l.searchPhone=o),placeholder:"搜索电话后四位",style:{width:"250px"},clearable:"",onClear:l.loadLeads,onInput:l.loadLeads},null,8,["modelValue","onClear","onInput"])]),t(m,{data:l.leads,style:{width:"100%"},stripe:"",onSortChange:l.handleSortChange},{default:n(()=>[t(d,{prop:"full_name",label:"姓名"}),t(d,{prop:"phone",label:"电话",sortable:""}),t(d,{prop:"company_name",label:"公司"}),t(d,{prop:"level",label:"客户等级"}),t(d,{prop:"latest_contact_result",label:"最近跟进"}),t(d,{prop:"follow_up_count",label:"跟进次数",sortable:""}),t(d,{label:"操作",width:"400"},{default:n(o=>[t(r,{size:"small",onClick:f=>l.viewDetail(o.row)},{default:n(()=>e[7]||(e[7]=[u("查看")])),_:2,__:[7]},1032,["onClick"]),o.row.converted?h("",!0):(c(),y(r,{key:0,size:"small",type:"info",onClick:f=>l.openFollowUpDialog(o.row)},{default:n(()=>e[8]||(e[8]=[u("跟进")])),_:2,__:[8]},1032,["onClick"])),o.row.converted?h("",!0):(c(),y(r,{key:1,size:"small",type:"primary",onClick:f=>l.editLead(o.row)},{default:n(()=>e[9]||(e[9]=[u("编辑")])),_:2,__:[9]},1032,["onClick"])),o.row.converted?h("",!0):(c(),y(r,{key:2,size:"small",type:"danger",onClick:f=>l.deleteLead(o.row)},{default:n(()=>e[10]||(e[10]=[u("删除")])),_:2,__:[10]},1032,["onClick"])),o.row.converted?(c(),y(r,{key:4,size:"small",disabled:""},{default:n(()=>e[12]||(e[12]=[u("已成交")])),_:1,__:[12]})):(c(),y(r,{key:3,size:"small",type:"success",onClick:f=>v.convertToCustomer(o.row)},{default:n(()=>e[11]||(e[11]=[u("转为客户")])),_:2,__:[11]},1032,["onClick"]))]),_:1})]),_:1},8,["data","onSortChange"]),t(k,{style:{"margin-top":"16px"},background:"",layout:"prev, pager, next, jumper",total:l.total,"page-size":l.pageSize,"current-page":l.page,onCurrentChange:l.handlePageChange},null,8,["total","page-size","current-page","onCurrentChange"]),t(x,{title:"添加跟进记录",modelValue:l.showFollowUpDialog,"onUpdate:modelValue":e[5]||(e[5]=o=>l.showFollowUpDialog=o),width:"500px","append-to-body":""},{default:n(()=>[t(V,{model:l.followUpForm,"label-width":"100px"},{default:n(()=>[t(g,{label:"跟进结果"},{default:n(()=>[t(_,{type:"textarea",modelValue:l.followUpForm.contact_result,"onUpdate:modelValue":e[1]||(e[1]=o=>l.followUpForm.contact_result=o)},null,8,["modelValue"])]),_:1}),t(g,{label:"下次跟进时间"},{default:n(()=>[t(U,{modelValue:l.followUpForm.next_follow_up_date,"onUpdate:modelValue":e[2]||(e[2]=o=>l.followUpForm.next_follow_up_date=o),type:"date",placeholder:"选择日期",format:"yyyy-MM-dd","value-format":"yyyy-MM-dd"},null,8,["modelValue"])]),_:1}),t(g,{label:"备注"},{default:n(()=>[t(_,{type:"textarea",modelValue:l.followUpForm.notes,"onUpdate:modelValue":e[3]||(e[3]=o=>l.followUpForm.notes=o)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),L("span",M,[t(r,{onClick:e[4]||(e[4]=o=>l.showFollowUpDialog=!1)},{default:n(()=>e[13]||(e[13]=[u("取消")])),_:1,__:[13]}),t(r,{type:"primary",onClick:l.submitFollowUp},{default:n(()=>e[14]||(e[14]=[u("提交")])),_:1,__:[14]},8,["onClick"])])]),_:1},8,["modelValue"])])}const O=z(P,[["render",B],["__scopeId","data-v-42362369"]]);export{O as default};
